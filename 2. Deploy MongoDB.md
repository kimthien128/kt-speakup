-   **Mục tiêu**: MongoDB sẽ được sử dụng bởi backend FastAPI tại `http://127.0.0.1:8000/` và tích hợp với ứng dụng web tại `https://speakup.ktstudio.vn`.

---

### Bước 1: Cài đặt MongoDB Community Edition

MongoDB cung cấp gói chính thức (`mongodb-org`) từ kho lưu trữ của họ, đảm bảo phiên bản mới nhất (hiện tại là 8.0 vào tháng 5/2025). Chúng ta sẽ cài đặt MongoDB trên Ubuntu theo hướng dẫn từ tài liệu chính thức của MongoDB.[](https://www.mongodb.com/docs/manual/tutorial/install-mongodb-on-ubuntu/)

#### 1. Cập nhật hệ thống

```bash
sudo apt update
sudo apt upgrade -y
```

#### 2. Cài đặt các gói phụ thuộc

Cài đặt các công cụ cần thiết như `gnupg`, `wget`, và `curl`:

```bash
sudo apt install -y gnupg wget apt-transport-https ca-certificates software-properties-common
```

#### 3. Thêm khóa GPG của MongoDB

Nhập khóa GPG công khai để xác thực gói MongoDB:

```bash
curl -fsSL https://pgp.mongodb.com/server-8.0.asc | sudo gpg -o /usr/share/keyrings/mongodb-server-8.0.gpg --dearmor
```

#### 4. Thêm kho lưu trữ MongoDB

Tạo file danh sách nguồn cho MongoDB. Tùy thuộc vào phiên bản Ubuntu, sử dụng lệnh phù hợp:

Kiểm tra phiên bản Ubuntu nếu bạn không chắc:

```bash
lsb_release -dc
```

-   **Ubuntu 24.04 (Noble Numbat)**:

    ```bash
    echo "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-8.0.gpg ] https://repo.mongodb.org/apt/ubuntu noble/mongodb-org/8.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-8.0.list
    ```

-   **Ubuntu 22.04 (Jammy)**:

    ```bash
    echo "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-8.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/8.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-8.0.list
    ```

-   **Ubuntu 20.04 (Focal)**:
    ```bash
    echo "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-8.0.gpg ] https://repo.mongodb.org/apt/ubuntu focal/mongodb-org/8.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-8.0.list
    ```

#### 5. Cập nhật danh sách gói và cài đặt MongoDB

```bash
sudo apt update
sudo apt install -y mongodb-org
```

Gói `mongodb-org` bao gồm `mongod` (server), `mongosh` (shell), và các công cụ khác.

#### 6. Kiểm tra cài đặt

Xác nhận phiên bản MongoDB:

```bash
mongod --version
```

Kết quả mẫu:

```
db version v8.0.5
Build Info: { "version": "8.0.5", ... }
```

---

### Bước 2: Khởi động và cấu hình dịch vụ MongoDB

MongoDB sử dụng `systemd` để quản lý dịch vụ.

#### 1. Khởi động dịch vụ MongoDB

```bash
sudo systemctl start mongod
```

#### 2. Kích hoạt khởi động cùng hệ thống

```bash
sudo systemctl enable mongod
```

#### 3. Kiểm tra trạng thái

```bash
sudo systemctl status mongod
```

-   Đảm bảo dịch vụ đang chạy (`active (running)`).
-   Kiểm tra log để xác nhận MongoDB sẵn sàng:
    ```bash
    sudo tail -n 20 /var/log/mongodb/mongod.log
    ```
    Tìm dòng như:
    ```
    [initandlisten] waiting for connections on port 27017
    ```

#### 4. Kiểm tra kết nối cục bộ

Kết nối đến MongoDB bằng `mongosh`:

```bash
mongosh
```

-   Nếu kết nối thành công, bạn sẽ thấy shell MongoDB:
    ```
    Current Mongosh Log ID: ...
    Using MongoDB: 8.0.5
    test>
    ```
-   Thoát shell:
    ```javascript
    exit;
    ```

---

### Bước 3: Cấu hình bảo mật cho MongoDB

Mặc định, MongoDB không yêu cầu xác thực, điều này không an toàn cho triển khai sản xuất. Chúng ta sẽ bật xác thực và tạo người dùng quản trị.[](https://phoenixnap.com/kb/how-to-install-mongodb-ubuntu)

#### 1. Truy cập MongoDB Shell

```bash
mongosh
```

#### 2. Chuyển sang database `admin`

```javascript
use admin
```

#### 3. Tạo người dùng quản trị

Tạo người dùng với quyền quản trị toàn hệ thống. Thay `mongodbadmin` và `your_secure_password` bằng tên người dùng và mật khẩu bạn chọn:

```javascript
db.createUser({
    user: 'mongodbadmin',
    pwd: 'abc@123A',
    roles: [
        {role: 'userAdminAnyDatabase', db: 'admin'},
        {role: 'readWriteAnyDatabase', db: 'admin'},
        {role: 'dbAdminAnyDatabase', db: 'admin'},
    ],
});
```

Kết quả:

```
{ ok: 1 }
```

#### 4. Thoát shell

```javascript
exit;
```

#### 5. Bật xác thực (chưa cần làm)

Chỉnh sửa file cấu hình MongoDB:

```bash
sudo nano /etc/mongod.conf
```

Tìm phần `security` và bật xác thực:

```yaml
security:
    authorization: 'enabled'
```

Nếu không có phần `security`, thêm nó vào cuối file.

#### 6. Khởi động lại MongoDB

```bash
sudo systemctl restart mongod
```

#### 7. Kiểm tra xác thực

Kết nối lại với thông tin người dùng:

```bash
mongosh -u mongodbadmin -p --authenticationDatabase admin
```

-   Nhập mật khẩu khi được yêu cầu.
-   Xác nhận bạn có thể truy cập shell và liệt kê người dùng:
    ```javascript
    use admin
    db.getUsers()
    ```
    Kết quả sẽ hiển thị thông tin `mongodbadmin`.

---

### Bước 4: Cấu hình MongoDB cho ứng dụng web

-   Bật connection string với mongodb `mongodb://localhost:27017`mongodb://localhost:27017

### Bước 5: Cấu hình kết nối từ xa (nếu cần)

Mặc định, MongoDB chỉ cho phép kết nối cục bộ (`bindIp: 127.0.0.1`). Nếu backend chạy trên máy khác hoặc bạn cần truy cập từ xa (ví dụ: từ máy local để debug), cấu hình như sau:[](https://phoenixnap.com/kb/how-to-install-mongodb-ubuntu)

#### 1. Chỉnh sửa file cấu hình

```bash
sudo nano /etc/mongod.conf
```

Tìm phần `net` và cập nhật `bindIp`:

```yaml
net:
    port: 27017
    bindIp: 127.0.0.1,157.230.242.152 # Thêm IP của VPS
```

Hoặc cho phép tất cả IP (ít an toàn hơn):

```yaml
bindIp: 0.0.0.0
```

#### 2. Mở cổng firewall

Cho phép cổng 27017 từ IP cụ thể (thay `192.168.1.100` bằng IP của bạn):

```bash
sudo ufw allow from 192.168.1.100 to any port 27017
```

Kiểm tra firewall:

```bash
sudo ufw status
```

#### 3. Khởi động lại MongoDB

```bash
sudo systemctl restart mongod
```

#### 4. Kiểm tra kết nối từ xa

Từ máy local, cài `mongosh` (theo hướng dẫn tại) và thử kết nối:[](https://www.mongodb.com/docs/mongodb-shell/install/)

```powershell
mongosh "mongodb://mongodbadmin:your_secure_password@157.230.242.152:27017/admin"
```
