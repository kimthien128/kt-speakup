-   tắt file .env.local
-   Cập nhật .env trong frontend: `VITE_API_URL=https://speakup.ktstudio.vn/api`
-   Deploy frontend lại

## Dùng HTTPS với Let’s Encrypt:

```
sudo apt install nginx certbot python3-certbot-nginx -y

sudo certbot --nginx
hoặc
sudo certbot --nginx -d speakup.ktstudio.vn

sudo nginx -t
sudo systemctl restart nginx
```

## sửa luôn biến minio_endpoint trong .env của backend:

`nano kt-speakup/backend/.env`

-   sửa cấu hình khởi tạo minio_client.py: bật secure = True\
    `nano kt-speakup/backend/storage/minio_client.py`

### file cấu hình biến môi trường cho minio:

`sudo nano /etc/default/minio`\

```
# Đường dẫn lưu trữ dữ liệu
MINIO_VOLUMES="/home/minio-user/data"

#MINIO_VOLUMES="/usr/local/share/minio"

# Tùy chọn khởi động MinIO, bao gồm --certs-dir để bật HTTPS
MINIO_OPTS="--certs-dir /home/minio-user/certs --console-address :9001"

# URL công khai của MinIO (dùng trong FastAPI và frontend)
MINIO_SERVER_URL="https://speakup.ktstudio.vn/storage"

#MINIO_OPTS="--address :9000 --console-address :9001"

MINIO_ROOT_USER=admin
MINIO_ROOT_PASSWORD=abc@123A

```

-   kiểm tra thư mục lưu trữ: `ls -ld /home/minio-user/data`
-   Nếu không tồn tại, tạo và đặt quyền:

```
sudo mkdir -p /home/minio-user/data
sudo chown minio-user:minio-user /home/minio-user/data
```

-   kiểm tra thư mục chứng chỉ: `ls -l /home/minio-user/certs`
-   Nếu không có, sao chép chứng chỉ Let's Encrypt

```
sudo mkdir -p /home/minio-user/certs
sudo cp /etc/letsencrypt/live/speakup.ktstudio.vn/fullchain.pem /home/minio-user/certs/public.crt
sudo cp /etc/letsencrypt/live/speakup.ktstudio.vn/privkey.pem /home/minio-user/certs/private.key
sudo chown minio-user:minio-user /home/minio-user/certs/*
sudo chmod 600 /home/minio-user/certs/*
```

-   kiểm tra chứng chỉ: `openssl x509 -in /home/minio-user/certs/public.crt -text -noout`
-   Kiểm tra file dịch vụ: `sudo nano /etc/systemd/system/minio.service`

```
[Unit]
Description=MinIO Object Storage
Documentation=https://docs.min.io
Wants=network-online.target
After=network-online.target
AssertFileIsExecutable=/usr/local/bin/minio

[Service]
User=minio-user
Group=minio-user
EnvironmentFile=/etc/default/minio
ExecStart=/usr/local/bin/minio server $MINIO_OPTS $MINIO_VOLUMES
Restart=always
LimitNOFILE=65536
TimeoutStopSec=0

[Install]
WantedBy=multi-user.target
```

```
sudo systemctl daemon-reexec
sudo systemctl daemon-reload
sudo systemctl restart minio
sudo systemctl status minio
```

-   Kiểm tra có access denied là ok:

```
curl -k https://localhost:9000
curl -k https://localhost:9001
```

-   Cập nhật cấu hình Nginx, sửa thành https và bổ sung 2 dòng cuối: `sudo nano /etc/nginx/sites-available/kt-speakup`

```
location /storage/ {
    proxy_pass https://127.0.0.1:9000/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
```

```
sudo nginx -t
sudo systemctl reload nginx
```

`sudo service ktspeakup restart`\
`sudo journalctl -u ktspeakup -f`
