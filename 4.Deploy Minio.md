### **Bước 1: Cài đặt MinIO**

1. **Cập nhật hệ thống**

    ```bash
    sudo apt update && sudo apt upgrade -y
    ```

2. **Tải MinIO binary** MinIO là một binary độc lập, bạn có thể tải phiên bản mới nhất từ trang chính thức:

    ```bash
    wget https://dl.min.io/server/minio/release/linux-amd64/minio -O /usr/local/bin/minio
    ```

3. **Phân quyền cho binary**

    ```bash
    chmod +x /usr/local/bin/minio
    ```

4. **Tạo thư mục lưu trữ dữ liệu** MinIO cần một thư mục để lưu trữ các bucket và object. Ví dụ:

    ```bash
    sudo mkdir /minio-data
    sudo chown -R $USER:$USER /minio-data
    ```

5. **Tạo user và group cho MinIO** Để tăng tính bảo mật, tạo một user riêng cho MinIO:
    ```bash
    sudo useradd -r minio-user -s /sbin/nologin
    sudo chown minio-user:minio-user /minio-data
    sudo chown minio-user:minio-user /usr/local/bin/minio
    ```

---

### **Bước 2: Cấu hình MinIO như một dịch vụ Systemd**

1. **Tạo file dịch vụ Systemd** Tạo file cấu hình dịch vụ MinIO:

    ```bash
    sudo nano /etc/systemd/system/minio.service
    ```

2. **Thêm nội dung sau vào file**

    ```ini
    [Unit]
    Description=MinIO
    Documentation=https://docs.min.io
    Wants=network-online.target
    After=network-online.target
    AssertFileIsExecutable=/usr/local/bin/minio

    [Service]
    WorkingDirectory=/minio-data
    User=minio-user
    Group=minio-user
    EnvironmentFile=/etc/default/minio
    ExecStart=/usr/local/bin/minio server /minio-data --console-address ":9001" --address ":9000"
    Restart=always
    LimitNOFILE=65536
    TimeoutStopSec=0

    [Install]
    WantedBy=multi-user.target
    ```

3. **Tạo file môi trường cho MinIO** Tạo file cấu hình để lưu thông tin đăng nhập (access key và secret key):

    ```bash
    sudo nano /etc/default/minio
    ```

    Thêm nội dung sau (thay đổi `MINIO_ROOT_USER` và `MINIO_ROOT_PASSWORD` theo ý muốn, mật khẩu nên dài hơn 8 ký tự):

    ```bash
    MINIO_ROOT_USER=admin
    MINIO_ROOT_PASSWORD=abc@123A
    MINIO_VOLUMES=/minio-data
    ```

4. **Reload Systemd và khởi động dịch vụ**

    ```bash
    sudo systemctl daemon-reload
    sudo systemctl enable minio
    sudo systemctl start minio
    ```

5. **Kiểm tra trạng thái dịch vụ**

    ```bash
    sudo systemctl status minio
    ```

    Nếu dịch vụ chạy bình thường, bạn sẽ thấy trạng thái `active (running)`.

---

### **Bước 3: Cấu hình Firewall và mạng**

1. **Mở cổng 9000 (API) và 9001 (Console)** Nếu sử dụng `ufw`:

    ```bash
    sudo ufw allow 9000
    sudo ufw allow 9001
    sudo ufw reload
    ```

    Nếu sử dụng `iptables` hoặc firewall khác, đảm bảo các cổng này được mở.

2. **Kiểm tra truy cập nội bộ** Từ server, thử truy cập giao diện web của MinIO:

    ```bash
    curl http://localhost:9001
    ```

    Hoặc mở trình duyệt và truy cập: `http://<server-ip>:9001`. Đăng nhập bằng `MINIO_ROOT_USER` và `MINIO_ROOT_PASSWORD` đã cấu hình.

3. **Cấu hình truy cập từ bên ngoài**
    - Nếu server có IP tĩnh hoặc tên miền, bạn có thể truy cập MinIO từ bên ngoài qua `http://<server-ip>:9001` hoặc `http://<domain>:9001`.
    - Để tăng bảo mật, bạn nên cấu hình SSL/TLS (xem Bước 5).

---

### **Bước 4: Kiểm tra API**

MinIO hỗ trợ API tương thích S3. Bạn có thể kiểm tra bằng `curl` hoặc SDK như AWS CLI:

1. **Cài đặt AWS CLI (tùy chọn)**

    ```bash
    sudo apt install awscli -y
    nếu lỗi thì dùng snap để cài
    sudo snap install aws-cli --classic
    ```

2. **Cấu hình AWS CLI**

    ```bash
    aws configure
    ```

    Nhập thông tin:

    - AWS Access Key ID: `MINIO_ROOT_USER` (ví dụ: `admin`)
    - AWS Secret Access Key: `MINIO_ROOT_PASSWORD` (ví dụ: `yourstrongpassword`)
    - Default region name: để trống hoặc nhập `us-east-1`
    - Default output format: để trống hoặc nhập `json`

3. **Kiểm tra bucket**

    ```bash
    aws --endpoint-url http://<server-ip>:9000 s3 ls
    ```

    Nếu thành công, bạn sẽ thấy danh sách các bucket.

---

### **Bước 5: Tăng cường bảo mật (Tùy chọn nhưng khuyến nghị)**

1.  **Cấu hình SSL/TLS**

    -   Sử dụng Let's Encrypt để lấy chứng chỉ SSL miễn phí:
        ```bash
        sudo apt install certbot python3-certbot-nginx
        sudo certbot certonly --standalone -d <your-domain>
        ```
    -   Copy chứng chỉ vào thư mục MinIO:
        ```bash
        sudo mkdir -p ~/.minio/certs
        sudo cp /etc/letsencrypt/live/<your-domain>/fullchain.pem ~/.minio/certs/public.crt
        sudo cp /etc/letsencrypt/live/<your-domain>/privkey.pem ~/.minio/certs/private.key
        sudo chown -R minio-user:minio-user ~/.minio/certs
        ```
    -   Khởi động lại MinIO:
        ```bash
        sudo systemctl restart minio
        ```

    Bây giờ, bạn có thể truy cập qua `https://<your-domain>:9001`.

2.  **Cấu hình Reverse Proxy với Nginx (Tùy chọn)** Nếu muốn sử dụng tên miền đẹp hoặc quản lý SSL dễ dàng hơn, cài Nginx và cấu hình reverse proxy:

```bash
sudo apt install nginx -y
sudo nano /etc/nginx/sites-available/kt-speakup
```

```nginx
server {
    if ($host = speakup.ktstudio.vn) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


    listen 80;
    server_name speakup.ktstudio.vn;
    return 301 https://$host$request_uri;


}

server {
    listen 443 ssl;
    server_name speakup.ktstudio.vn;
    ssl_certificate /etc/letsencrypt/live/speakup.ktstudio.vn/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/speakup.ktstudio.vn/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # Phục vụ file tĩnh từ frontend
    root /var/www/kt-speakup;

    # Phục vụ file trong /assets/ trực tiếp
    location /assets/ {
        try_files $uri =404;  # Trả về 404 nếu file không tồn tại
    }

    # Phục vụ SPA
    location / {
        try_files $uri $uri/ /index.html;
    }

    # API backend
    location /api/ {
        proxy_pass http://127.0.0.1:8000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        client_max_body_size 10M; # Xử lý lỗi too large body
    }
}

server {
    if ($host = storage.speakup.ktstudio.vn) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


    listen 80;
    server_name storage.speakup.ktstudio.vn;
    return 301 https://$host$request_uri;


}

server {
    listen 443 ssl;
    server_name storage.speakup.ktstudio.vn;
    ssl_certificate /etc/letsencrypt/live/speakup.ktstudio.vn/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/speakup.ktstudio.vn/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    location / {
        proxy_pass http://127.0.0.1:9000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect off;
        client_max_body_size 100M;
    }

}

```

    Kích hoạt và khởi động Nginx:

    ```bash
    sudo nginx -t
    sudo systemctl restart nginx
    ```

3. **Bảo mật thêm**
    - Đổi cổng mặc định (9000, 9001) trong file `/etc/systemd/system/minio.service` nếu cần.
    - Sử dụng firewall để giới hạn IP truy cập.
    - Cập nhật MinIO thường xuyên để vá lỗ hổng bảo mật.

---

### **Bước 6: Sử dụng MinIO**

-   **Truy cập giao diện web**: Mở trình duyệt và vào `http://<server-ip>:9001` hoặc `https://<your-domain>:9001`.
-   **Sử dụng SDK hoặc CLI**: MinIO tương thích với các công cụ S3 như `boto3` (Python), AWS SDK, hoặc `mc` (MinIO Client).

    -   Cài đặt `mc`:
        ```bash
        wget https://dl.min.io/client/mc/release/linux-amd64/mc
        chmod +x mc
        sudo mv mc /usr/local/bin/
        ```
    -   Cấu hình `mc`:
        ```bash
        mc alias set myminio http://<server-ip>:9000 admin yourstrongpassword
        ```
    -   Tạo bucket:
        ```bash
        mc mb myminio/my-bucket
        ```

-   **Truy cập từ ứng dụng**: Cung cấp endpoint `http://<server-ip>:9000` hoặc `https://<your-domain>:9000` cùng access key và secret key cho ứng dụng.

```

```

Việc bạn đã tạo subdomain `storage.speakup.ktstudio.vn` trỏ về cùng IP với `speakup.ktstudio.vn` (`157.230.242.152`) là một ý tưởng tuyệt vời để tách biệt dịch vụ MinIO và sử dụng URL thống nhất (`https://storage.speakup.ktstudio.vn/...`) cho cả môi trường local và production. Điều này sẽ giúp:

-   Truy cập MinIO từ mọi nơi (bao gồm máy local) qua HTTPS.
-   Loại bỏ lỗi Mixed Content vì tất cả URL sẽ sử dụng HTTPS.
-   Tránh các URL cục bộ như `http://localhost:9000` trong database.

Để cấu hình MinIO sử dụng subdomain `storage.speakup.ktstudio.vn` và đảm bảo hoạt động từ cả máy local (`localhost`) lẫn các client khác, chúng ta cần:

1. Cập nhật cấu hình Nginx để proxy yêu cầu tới `storage.speakup.ktstudio.vn` tới MinIO.
2. Sửa `minio_client.py` để sử dụng `storage.speakup.ktstudio.vn` làm endpoint và tạo URL công khai.
3. Kiểm tra SSL và DNS cho subdomain.
4. Đảm bảo bucket và policy MinIO được thiết lập đúng.
5. Kiểm tra kết nối từ máy local và xác nhận URL thống nhất.

Dưới đây là các bước chi tiết để triển khai.

---

### 1. Cập nhật cấu hình Nginx cho subdomain

Bạn cần thêm một khối server trong Nginx để xử lý yêu cầu tới `storage.speakup.ktstudio.vn` và proxy chúng tới MinIO (chạy trên `127.0.0.1:9000`).

#### Bước thực hiện:

1. **Mở file cấu hình Nginx**:

    ```bash
    sudo nano /etc/nginx/sites-available/kt-speakup
    ```

2. **Thêm khối server mới**: Thêm cấu hình sau vào file `/etc/nginx/sites-available/kt-speakup`:

    ```nginx
    server {
        listen 80;
        server_name storage.speakup.ktstudio.vn;
        return 301 https://$host$request_uri;
    }

    server {
        listen 443 ssl;
        server_name storage.speakup.ktstudio.vn;

        ssl_certificate /etc/letsencrypt/live/speakup.ktstudio.vn/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/speakup.ktstudio.vn/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

        location / {
            proxy_pass http://127.0.0.1:9000/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_redirect off;
            client_max_body_size 100M;
        }
    }
    ```

    **Giải thích**:

    - Khối `listen 80` chuyển hướng HTTP sang HTTPS.
    - Khối `listen 443 ssl` xử lý yêu cầu HTTPS tới `storage.speakup.ktstudio.vn`.
    - Sử dụng cùng chứng chỉ SSL của `speakup.ktstudio.vn` (giả định chứng chỉ này là wildcard hoặc bao gồm `storage.speakup.ktstudio.vn`).
    - Proxy tất cả yêu cầu tới MinIO (`http://127.0.0.1:9000`).

3. **Kiểm tra và khởi động lại Nginx**:

    ```bash
    sudo nginx -t
    sudo systemctl restart nginx
    ```

4. **Kiểm tra proxy**:
    ```bash
    curl -v https://storage.speakup.ktstudio.vn/
    ```
    Dự kiến trả về XML từ MinIO (có thể là `AccessDenied` nếu không có xác thực).

---

### 2. Kiểm tra chứng chỉ SSL cho subdomain

Chứng chỉ Let's Encrypt hiện tại (`/etc/letsencrypt/live/speakup.ktstudio.vn/`) có thể không bao gồm `storage.speakup.ktstudio.vn`. Bạn cần cập nhật chứng chỉ để hỗ trợ subdomain.

#### Bước thực hiện:

1. **Kiểm tra chứng chỉ hiện tại**:

    ```bash
    sudo certbot certificates
    ```

    Xem danh sách domain trong chứng chỉ. Nếu `storage.speakup.ktstudio.vn` không có, mở rộng chứng chỉ.

2. **Mở rộng chứng chỉ**:

    ```bash
    sudo certbot --expand -d speakup.ktstudio.vn,storage.speakup.ktstudio.vn
    ```

    Hoặc tạo chứng chỉ mới:

    ```bash
    sudo certbot --nginx -d speakup.ktstudio.vn -d storage.speakup.ktstudio.vn
    ```

3. **Cập nhật cấu hình Nginx (nếu cần)**: Nếu chứng chỉ được lưu ở vị trí khác (ví dụ: `/etc/letsencrypt/live/storage.speakup.ktstudio.vn/`), cập nhật khối server:

    ```nginx
    ssl_certificate /etc/letsencrypt/live/storage.speakup.ktstudio.vn/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/storage.speakup.ktstudio.vn/privkey.pem;
    ```

4. **Khởi động lại Nginx**:

    ```bash
    sudo systemctl restart nginx
    ```

5. **Kiểm tra SSL**:
    ```bash
    curl -v https://storage.speakup.ktstudio.vn/
    ```
    Tìm `* SSL certificate verify ok`.

---

### 3. Sửa file `minio_client.py`

Để backend trên máy local kết nối tới MinIO trên VPS qua `storage.speakup.ktstudio.vn` và sử dụng URL công khai `https://storage.speakup.ktstudio.vn/...`, bạn cần sửa `minio_client.py`.

#### File sửa đổi:

```python
# storage/minio_client.py
# Triển khai StorageClient cho MinIO.
# Khởi tạo MinIO client và cấu hình bucket policy.
# Tuân thủ SRP: Chỉ xử lý logic liên quan đến MinIO.

import os
import json
from minio import Minio
from minio.error import S3Error
from .storage_client import StorageClient
from ..logging_config import logger
import urllib3

# Tắt cảnh báo SSL không xác minh (tạm thời cho debug)
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

class MinioClient(StorageClient):
    def __init__(self):
        self.access_key = os.getenv("MINIO_ACCESS_KEY")
        self.secret_key = os.getenv("MINIO_SECRET_KEY")
        self.image_bucket = os.getenv("IMAGE_BUCKET")
        self.audio_bucket = os.getenv("AUDIO_BUCKET")
        self.avatars_bucket = os.getenv("AVATARS_BUCKET")

        # Kiểm tra các biến môi trường
        if not all([self.access_key, self.secret_key, self.image_bucket, self.audio_bucket, self.avatars_bucket]):
            logger.error("Missing required environment variables for MinIO")
            raise ValueError("MINIO_ACCESS_KEY, MINIO_SECRET_KEY, IMAGE_BUCKET, AUDIO_BUCKET, or AVATARS_BUCKET not set")

        self.client = Minio(
            endpoint="storage.speakup.ktstudio.vn:443",  # Endpoint HTTPS cho subdomain
            access_key=self.access_key,
            secret_key=self.secret_key,
            secure=True  # Sử dụng HTTPS
        )
        # Lưu URL công khai để tạo URL
        self.public_endpoint = os.getenv("MINIO_ENDPOINT", "https://storage.speakup.ktstudio.vn")
        if not self.public_endpoint.startswith("https://"):
            logger.warning(f"MINIO_ENDPOINT should use HTTPS, got {self.public_endpoint}. Using default.")
            self.public_endpoint = "https://storage.speakup.ktstudio.vn"

        logger.info(f"MinIO public endpoint: {self.public_endpoint}")
        self._initialize_buckets()

    def _generate_public_read_policy(self, bucket_name: str) -> str:
        """Tạo policy cho phép đọc công khai cho bucket."""
        policy = {
            "Version": "2012-10-17",
            "Statement": [
                {
                    "Effect": "Allow",
                    "Principal": "*",
                    "Action": ["s3:GetObject"],
                    "Resource": [f"arn:aws:s3:::{bucket_name}/*"]
                }
            ]
        }
        return json.dumps(policy)

    def _setup_bucket(self, bucket_name: str):
        """Khởi tạo bucket và thiết lập policy."""
        try:
            if not self.bucket_exists(bucket_name):
                self.make_bucket(bucket_name)
                logger.info(f"Created bucket: {bucket_name}")
            else:
                logger.info(f"Bucket already exists: {bucket_name}")

            policy = self._generate_public_read_policy(bucket_name)
            self.set_bucket_policy(bucket_name, policy)
            logger.info(f"Public read policy set for bucket: {bucket_name}")
        except S3Error as e:
            logger.error(f"Error configuring MinIO bucket {bucket_name}: {e}")
            raise

    def _initialize_buckets(self):
        """Khởi tạo các bucket và thiết lập policy."""
        self._setup_bucket(self.image_bucket)
        self._setup_bucket(self.audio_bucket)
        self._setup_bucket(self.avatars_bucket)

    def bucket_exists(self, bucket_name: str) -> bool:
        """Kiểm tra xem bucket có tồn tại hay không."""
        try:
            response = self.client.bucket_exists(bucket_name)
            logger.info(f"Bucket {bucket_name} exists: {response}")
            return response
        except Exception as e:
            logger.error(f"Error checking bucket {bucket_name}: {e}")
            if hasattr(e, 'response') and e.response:
                logger.error(f"Response content: {e.response.data.decode()}")
            raise

    def make_bucket(self, bucket_name: str):
        """Tạo bucket mới."""
        self.client.make_bucket(bucket_name)

    def set_bucket_policy(self, bucket_name: str, policy: str):
        """Thiết lập policy cho bucket."""
        self.client.set_bucket_policy(bucket_name, policy)

    def list_objects(self, bucket_name: str, recursive: bool = True) -> list:
        return self.client.list_objects(bucket_name, recursive=recursive)

    def stat_object(self, bucket_name: str, object_name: str) -> dict:
        return self.client.stat_object(bucket_name, object_name)

    def remove_object(self, bucket_name: str, object_name: str):
        self.client.remove_object(bucket_name, object_name)

    def put_object(self, bucket_name: str, object_name: str, data, length: int, content_type: str):
        """Tải file lên bucket."""
        try:
            self.client.put_object(
                bucket_name=bucket_name,
                object_name=object_name,
                data=data,
                length=length,
                content_type=content_type
            )
            logger.info(f"Uploaded file to MinIO: {bucket_name}/{object_name}")
        except S3Error as e:
            logger.error(f"Failed to upload file to MinIO: {e}")
            raise

    def presigned_get_object(self, bucket_name: str, object_name: str) -> str:
        """Tạo URL công khai để truy cập file."""
        try:
            url = f"{self.public_endpoint.rstrip('/')}/{bucket_name}/{object_name}"
            logger.info(f"Generated URL: {url}")
            return url
        except S3Error as e:
            logger.error(f"Failed to generate URL: {e}")
            raise
```

#### Thay đổi chính:

1. **Cập nhật endpoint**:
    - Thay `speakup.ktstudio.vn:443` bằng `storage.speakup.ktstudio.vn:443` trong `Minio` client.
2. **Cập nhật `public_endpoint`**:
    - Mặc định là `https://storage.speakup.ktstudio.vn` thay vì `https://speakup.ktstudio.vn/storage`.
3. **Giữ debug và kiểm tra HTTPS**:
    - Giữ logic debug trong `bucket_exists` và kiểm tra HTTPS cho `public_endpoint`.

---

### 4. Cập nhật biến môi trường trên máy local

Cập nhật file `.env` trên máy local để phản ánh subdomain mới:

```env
MINIO_ENDPOINT=https://storage.speakup.ktstudio.vn
MINIO_ACCESS_KEY=admin
MINIO_SECRET_KEY=abc@123A
AUDIO_BUCKET=audio-bucket
AVATARS_BUCKET=avatars-bucket
IMAGE_BUCKET=image-bucket
```

Đảm bảo `python-dotenv` được sử dụng trong `backend/server.py`:

```python
from dotenv import load_dotenv
load_dotenv()
```

---

### 5. Kiểm tra DNS và kết nối

Xác nhận subdomain `storage.speakup.ktstudio.vn` hoạt động đúng.

1. **Kiểm tra DNS**:

    ```bash
    ping storage.speakup.ktstudio.vn
    ```

    Hoặc:

    ```powershell
    ping storage.speakup.ktstudio.vn
    ```

    Đảm bảo trả về IP `157.230.242.152`.

2. **Kiểm tra kết nối MinIO**:

    ```powershell
    curl -v https://storage.speakup.ktstudio.vn/ -u admin:abc@123A
    ```

    Dự kiến trả về XML hoặc danh sách bucket.

3. **Dùng `mc` trên máy local**:
    ```powershell
    curl -O https://dl.min.io/client/mc/release/windows-amd64/mc.exe
    mv mc.exe C:\Windows\System32\
    mc alias set myminio https://storage.speakup.ktstudio.vn admin abc@123A
    mc ls myminio
    ```

---

### 6. Kiểm tra bucket và policy trên VPS

Đảm bảo bucket (`image-bucket`, `audio-bucket`, `avatars-bucket`) tồn tại và có policy công khai.

1. **Dùng `mc` trên VPS**:

    ```bash
    mc alias set myminio http://localhost:9000 admin abc@123A
    mc ls myminio
    ```

    Nếu bucket không tồn tại:

    ```bash
    mc mb myminio/image-bucket
    mc mb myminio/audio-bucket
    mc mb myminio/avatars-bucket
    ```

2. **Áp dụng policy công khai**:

    ```bash
    echo '{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Principal":"*","Action":["s3:GetObject"],"Resource":["arn:aws:s3:::image-bucket/*"]}]}' > policy.json
    mc anonymous set-json policy.json myminio/image-bucket
    ```

    Lặp lại cho `audio-bucket` và `avatars-bucket`.

3. **Kiểm tra file**:
    ```bash
    mc ls myminio/image-bucket
    curl https://storage.speakup.ktstudio.vn/image-bucket/logoImage-4760668d-3bb6-4dff-8168-1f35f65d906e.png
    ```

---

### 7. Debug lỗi `ParseError`

Chạy backend trên máy local:

```powershell
python -m backend.server
```

Kiểm tra log để xem `Response content` trong lỗi `bucket_exists`. Nếu:

-   **AccessDenied**: Xác thực sai, kiểm tra lại `admin:abc@123A`.
-   **HTML/JSON**: Nginx proxy lỗi, kiểm tra:
    ```bash
    sudo tail -n 50 /var/log/nginx/error.log
    ```

---

### 8. Sửa backend lưu URL vào database

Để đảm bảo các URL mới lưu vào database sử dụng `https://storage.speakup.ktstudio.vn/...`:

1. Tìm mã lưu URL trong `backend/server.py` hoặc file route. Ví dụ:

    ```python
    url = f"http://localhost:9000/{bucket_name}/{object_name}"
    ```

    Thay bằng:

    ```python
    url = storage_client.presigned_get_object(bucket_name, object_name)
    ```

2. Kiểm tra endpoint upload:

    ```python
    from storage.minio_client import MinioClient

    storage_client = MinioClient()

    @app.post("/api/upload_image")
    async def upload_image(file: UploadFile = File(...)):
        object_name = f"{uuid.uuid4()}.{file.filename.split('.')[-1]}"
        content_type = file.content_type
        data = await file.read()
        storage_client.put_object("image-bucket", object_name, data, len(data), content_type)
        url = storage_client.presigned_get_object("image-bucket", object_name)
        # Lưu vào database
        db.settings.update({"logoImage": url})
        return {"url": url}
    ```

---

### 9. Kiểm tra toàn bộ

1. **Backend**:

    - Chạy `python -m backend.server`.
    - Gửi yêu cầu:
        ```powershell
        curl http://localhost:8000/api/get_image/logoImage-4760668d-3bb6-4dff-8168-1f35f65d906e.png
        ```
    - Xác nhận URL là `https://storage.speakup.ktstudio.vn/...`.

2. **Frontend**:

    - Truy cập `https://speakup.ktstudio.vn/chat`.
    - Kiểm tra DevTools -> Network, đảm bảo không có `http://localhost:9000`.

3. **MinIO**:
    - Truy cập `https://storage.speakup.ktstudio.vn/image-bucket/logoImage-4760668d-3bb6-4dff-8168-1f35f65d906e.png`.

---

### 10. Nếu vẫn gặp lỗi

Cung cấp:

1. Log backend sau khi sửa `minio_client.py`.
2. Kết quả của:
    ```powershell
    curl -v https://storage.speakup.ktstudio.vn/ -u admin:abc@123A
    ```
3. Log Nginx:
    ```bash
    sudo tail -n 50 /var/log/nginx/error.log
    ```
4. Log MinIO:
    ```bash
    sudo journalctl -u minio -n 100
    ```

---

### Tóm tắt

-   Subdomain `storage.speakup.ktstudio.vn` được sử dụng để truy cập MinIO từ mọi nơi, bao gồm máy local.
-   Cấu hình Nginx để proxy `storage.speakup.ktstudio.vn` tới MinIO.
-   Sửa `minio_client.py` để dùng `storage.speakup.ktstudio.vn:443` và tạo URL `https://storage.speakup.ktstudio.vn/...`.
-   Đảm bảo SSL, bucket, và backend lưu URL đúng.

Thực hiện các bước trên và kiểm tra lại. Nếu cần, gửi kết quả để tôi hỗ trợ tiếp!
