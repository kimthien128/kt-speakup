Để triển khai MinIO trên server Ubuntu như một dịch vụ có thể truy cập từ nội bộ và bên ngoài, bạn có thể làm theo các bước dưới đây. Hướng dẫn này sẽ đảm bảo MinIO chạy ổn định, tự động khởi động cùng hệ thống và có thể truy cập qua mạng.

---

### **Yêu cầu**

-   Server chạy Ubuntu (khuyến nghị Ubuntu 20.04 hoặc 22.04).
-   Quyền root hoặc tài khoản có quyền `sudo`.
-   Kết nối mạng ổn định.
-   Tùy chọn: Tên miền hoặc địa chỉ IP tĩnh để truy cập từ bên ngoài.
-   Đảm bảo các cổng cần thiết (mặc định 9000 cho API và 9001 cho giao diện web) được mở trên firewall.

---

### **Bước 1: Cài đặt MinIO**

1. **Cập nhật hệ thống**

    ```bash
    sudo apt update && sudo apt upgrade -y
    ```

2. **Tải MinIO binary** MinIO là một binary độc lập, bạn có thể tải phiên bản mới nhất từ trang chính thức:

    ```bash
    wget https://dl.min.io/server/minio/release/linux-amd64/minio -O /usr/local/bin/minio
    ```

3. **Phân quyền cho binary**

    ```bash
    chmod +x /usr/local/bin/minio
    ```

4. **Tạo thư mục lưu trữ dữ liệu** MinIO cần một thư mục để lưu trữ các bucket và object. Ví dụ:

    ```bash
    sudo mkdir /minio-data
    sudo chown -R $USER:$USER /minio-data
    ```

5. **Tạo user và group cho MinIO** Để tăng tính bảo mật, tạo một user riêng cho MinIO:
    ```bash
    sudo useradd -r minio-user -s /sbin/nologin
    sudo chown minio-user:minio-user /minio-data
    sudo chown minio-user:minio-user /usr/local/bin/minio
    ```

---

### **Bước 2: Cấu hình MinIO như một dịch vụ Systemd**

1. **Tạo file dịch vụ Systemd** Tạo file cấu hình dịch vụ MinIO:

    ```bash
    sudo nano /etc/systemd/system/minio.service
    ```

2. **Thêm nội dung sau vào file**

    ```ini
    [Unit]
    Description=MinIO
    Documentation=https://docs.min.io
    Wants=network-online.target
    After=network-online.target
    AssertFileIsExecutable=/usr/local/bin/minio

    [Service]
    WorkingDirectory=/minio-data
    User=minio-user
    Group=minio-user
    EnvironmentFile=/etc/default/minio
    ExecStart=/usr/local/bin/minio server /minio-data --console-address ":9001" --address ":9000"
    Restart=always
    LimitNOFILE=65536
    TimeoutStopSec=0

    [Install]
    WantedBy=multi-user.target
    ```

3. **Tạo file môi trường cho MinIO** Tạo file cấu hình để lưu thông tin đăng nhập (access key và secret key):

    ```bash
    sudo nano /etc/default/minio
    ```

    Thêm nội dung sau (thay đổi `MINIO_ROOT_USER` và `MINIO_ROOT_PASSWORD` theo ý muốn, mật khẩu nên dài hơn 8 ký tự):

    ```bash
    MINIO_ROOT_USER=admin
    MINIO_ROOT_PASSWORD=yourstrongpassword
    MINIO_VOLUMES=/minio-data
    ```

4. **Reload Systemd và khởi động dịch vụ**

    ```bash
    sudo systemctl daemon-reload
    sudo systemctl enable minio
    sudo systemctl start minio
    ```

5. **Kiểm tra trạng thái dịch vụ**

    ```bash
    sudo systemctl status minio
    ```

    Nếu dịch vụ chạy bình thường, bạn sẽ thấy trạng thái `active (running)`.

---

### **Bước 3: Cấu hình Firewall và mạng**

1. **Mở cổng 9000 (API) và 9001 (Console)** Nếu sử dụng `ufw`:

    ```bash
    sudo ufw allow 9000
    sudo ufw allow 9001
    sudo ufw reload
    ```

    Nếu sử dụng `iptables` hoặc firewall khác, đảm bảo các cổng này được mở.

2. **Kiểm tra truy cập nội bộ** Từ server, thử truy cập giao diện web của MinIO:

    ```bash
    curl http://localhost:9001
    ```

    Hoặc mở trình duyệt và truy cập: `http://<server-ip>:9001`. Đăng nhập bằng `MINIO_ROOT_USER` và `MINIO_ROOT_PASSWORD` đã cấu hình.

3. **Cấu hình truy cập từ bên ngoài**
    - Nếu server có IP tĩnh hoặc tên miền, bạn có thể truy cập MinIO từ bên ngoài qua `http://<server-ip>:9001` hoặc `http://<domain>:9001`.
    - Để tăng bảo mật, bạn nên cấu hình SSL/TLS (xem Bước 5).

---

### **Bước 4: Kiểm tra API**

MinIO hỗ trợ API tương thích S3. Bạn có thể kiểm tra bằng `curl` hoặc SDK như AWS CLI:

1. **Cài đặt AWS CLI (tùy chọn)**

    ```bash
    sudo apt install awscli -y
    nếu lỗi thì dùng snap để cài
    sudo snap install aws-cli --classic
    ```

2. **Cấu hình AWS CLI**

    ```bash
    aws configure
    ```

    Nhập thông tin:

    - AWS Access Key ID: `MINIO_ROOT_USER` (ví dụ: `admin`)
    - AWS Secret Access Key: `MINIO_ROOT_PASSWORD` (ví dụ: `yourstrongpassword`)
    - Default region name: để trống hoặc nhập `us-east-1`
    - Default output format: để trống hoặc nhập `json`

3. **Kiểm tra bucket**

    ```bash
    aws --endpoint-url http://<server-ip>:9000 s3 ls
    ```

    Nếu thành công, bạn sẽ thấy danh sách các bucket.

---

### **Bước 5: Tăng cường bảo mật (Tùy chọn nhưng khuyến nghị)**

1.  **Cấu hình SSL/TLS**

    -   Sử dụng Let's Encrypt để lấy chứng chỉ SSL miễn phí:
        ```bash
        sudo apt install certbot python3-certbot-nginx
        sudo certbot certonly --standalone -d <your-domain>
        ```
    -   Copy chứng chỉ vào thư mục MinIO:
        ```bash
        sudo mkdir -p ~/.minio/certs
        sudo cp /etc/letsencrypt/live/<your-domain>/fullchain.pem ~/.minio/certs/public.crt
        sudo cp /etc/letsencrypt/live/<your-domain>/privkey.pem ~/.minio/certs/private.key
        sudo chown -R minio-user:minio-user ~/.minio/certs
        ```
    -   Khởi động lại MinIO:
        ```bash
        sudo systemctl restart minio
        ```

    Bây giờ, bạn có thể truy cập qua `https://<your-domain>:9001`.

2.  **Cấu hình Reverse Proxy với Nginx (Tùy chọn)** Nếu muốn sử dụng tên miền đẹp hoặc quản lý SSL dễ dàng hơn, cài Nginx và cấu hình reverse proxy:

```bash
sudo apt install nginx -y
sudo nano /etc/nginx/sites-available/kt-speakup
```

Thêm nội dung:

```nginx
server {
    listen 80;
    server_name speakup.ktstudio.vn;
    return 301 https://$host$request_uri;
}

server { listen 443 ssl; server_name speakup.ktstudio.vn;

    ssl_certificate /etc/letsencrypt/live/speakup.ktstudio.vn/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/speakup.ktstudio.vn/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # Ứng dụng web tĩnh
    location / {
        root /var/www/kt-speakup;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # API backend
    location /api/ {
        proxy_pass http://127.0.0.1:8000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        client_max_body_size 10M; # Xử lý lỗi too large body
    }

    # API MinIO (/storage)
    location /storage/ {
        proxy_pass http://127.0.0.1:9000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect off;
    }

    # Chuyển hướng /storage sang /storage/
    location = /storage {
        return 301 https://$host/storage/;
    }

}

```

    Kích hoạt và khởi động Nginx:

    ```bash
    sudo ln -s /etc/nginx/sites-available/minio /etc/nginx/sites-enabled/
    sudo nginx -t
    sudo systemctl restart nginx
    ```

3. **Bảo mật thêm**
    - Đổi cổng mặc định (9000, 9001) trong file `/etc/systemd/system/minio.service` nếu cần.
    - Sử dụng firewall để giới hạn IP truy cập.
    - Cập nhật MinIO thường xuyên để vá lỗ hổng bảo mật.

---

### **Bước 6: Sử dụng MinIO**

-   **Truy cập giao diện web**: Mở trình duyệt và vào `http://<server-ip>:9001` hoặc `https://<your-domain>:9001`.
-   **Sử dụng SDK hoặc CLI**: MinIO tương thích với các công cụ S3 như `boto3` (Python), AWS SDK, hoặc `mc` (MinIO Client).

    -   Cài đặt `mc`:
        ```bash
        wget https://dl.min.io/client/mc/release/linux-amd64/mc
        chmod +x mc
        sudo mv mc /usr/local/bin/
        ```
    -   Cấu hình `mc`:
        ```bash
        mc alias set myminio http://<server-ip>:9000 admin yourstrongpassword
        ```
    -   Tạo bucket:
        ```bash
        mc mb myminio/my-bucket
        ```

-   **Truy cập từ ứng dụng**: Cung cấp endpoint `http://<server-ip>:9000` hoặc `https://<your-domain>:9000` cùng access key và secret key cho ứng dụng.

```

```
